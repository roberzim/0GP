<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calcolo Tariffe Avvocati</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-gray: #ecf0f1;
      --dark-gray: #7f8c8d;
      --success-color: #27ae60;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f9f9f9;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2, h3 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    h1 {
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 0.5rem;
    }
    
    select, input, button {
      font-family: inherit;
      font-size: inherit;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      padding: 0.6rem 1.2rem;
      font-weight: 500;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    button.reset {
      background-color: var(--dark-gray);
    }
    
    button.reset:hover {
      background-color: #6c7a7d;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 2rem 0;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      border-top: 4px solid var(--secondary-color);
    }
    
    .card h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    
    .form-row label {
      flex: 1;
      margin-right: 1rem;
    }
    
    .form-row input[type="number"],
    .form-row input[type="text"] {
      width: 80px;
      text-align: right;
    }
    
    .form-row span {
      font-size: 0.85rem;
      color: var(--dark-gray);
      margin-left: 0.5rem;
    }
    
    .table-container {
      overflow-x: auto;
      margin: 1.5rem 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
    }
    
    tr:nth-child(even) {
      background-color: var(--light-gray);
    }
    
    .total-box {
      background-color: var(--light-gray);
      padding: 1rem;
      border-radius: 4px;
      margin: 1.5rem 0;
      text-align: right;
      font-weight: bold;
    }
    
    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 1.5rem;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 1rem 0;
    }
    
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .form-row label {
        margin-bottom: 0.3rem;
      }
}
</style>
</head>
<body>
  <h1>Calcolo Tariffe Avvocati</h1>

  <!-- Modificato l'ordine e la logica di visualizzazione -->
  <div class="form-group" id="tipoTariffarioGroup">
    <label for="tipoTariffario">Tipo Tariffario:</label>
    <select id="tipoTariffario" class="full-width">
      <option value="tariffari_1fase">Tariffari 1 fase</option>
      <option value="tariffari_4fasi">Tariffari 4 fasi</option>
      <option value="tariffari_6fasi">Tariffari 6 fasi</option>
      <option value="stragiudiziale">Stragiudiziale</option>
    </select>
  </div>

  <div class="form-group" id="ambitoGroup">
    <label for="ambito">Ambito Giudiziario:</label>
    <select id="ambito" class="full-width"></select>
  </div>
  
  <div class="form-group">
    <label for="scaglione">Scaglione di Valore:</label>
    <select id="scaglione" class="full-width"></select>
  </div>
  
  <div class="table-container">
    <table id="fasi-table">
      <thead>
        <tr>
          <th>Seleziona</th>
          <th>Fase Processuale</th>
          <th>% Riduzione</th>
          <th>Valore Medio</th>
          <th>% Aumento</th>
          <th>Compenso Parziale</th>
        </tr>
      </thead>
      <tbody id="fasi"></tbody>
    </table>
  </div>
  
  <div class="total-box">
    Totale Compenso Tabellare: € <input type="text" id="totale" value="0.00" readonly>
  </div>
  
  <div class="grid">
    <!-- Sezione Aumenti -->
    <div class="card">
      <h3>Aumenti Percentuali</h3>
      <div class="form-row"><label>Numero parti:</label><input type="number" value="20" id="aumento-parti"><span>art. 4, c. 2</span></div>
      <div class="form-row"><label>Conciliazione:</label><input type="number" value="25" id="aumento-conciliazione"><span>art. 4, c. 6</span></div>
      <div class="form-row"><label>Class action:</label><input type="number" value="300" id="aumento-class"><span>art. 4, c. 10</span></div>
      <div class="form-row"><label>Manifesta fondatezza:</label><input type="number" value="30" id="aumento-fondatezza"><span>art. 4, c. 8</span></div>
      <div class="form-row"><label>Ulteriore valutazione:</label><input type="number" value="30" id="aumento-valutazione"><span>art. 4, c. 7</span></div>
      <div class="form-row"><label>Predisp. atti PCT:</label><input type="number" value="30" id="aumento-pct"><span>art. 4, c. 1-bis</span></div>
      <button type="button" class="reset" onclick="azzeraAumenti()">Azzera Aumenti</button>
    </div>
    
    <!-- Sezione Riduzioni -->
    <div class="card">
      <h3>Riduzioni Percentuali</h3>
      <div class="form-row"><label>Assenza quesiti:</label><input type="number" value="30" id="riduzione-assenza"><span>art. 4, c. 4</span></div>
      <div class="form-row"><label>Condotte ostative:</label><input type="number" value="50" id="riduzione-condotte"><span>art. 4, c. 7</span></div>
      <div class="form-row"><label>Resp. art. 96 cpc:</label><input type="number" value="75" id="riduzione-resp"><span>art. 4, c. 9</span></div>
      <div class="form-row"><label>Pronunce in rito:</label><input type="number" value="50" id="riduzione-rito"><span>art. 4, c. 9</span></div>
      <div class="form-row"><label>Gratuito patrocinio:</label><input type="number" value="50" id="riduzione-patrocinio"><span>art. 130 DPR 115/02</span></div>
      <div class="form-row"><label>Praticante abilitato:</label><input type="number" value="50" id="riduzione-praticante"><span>art. 9</span></div>
      <button type="button" class="reset" onclick="azzeraRiduzioni()">Azzera Riduzioni</button>
    </div>
    
    <!-- Sezione Spese -->
    <div class="card">
      <h3>Spese</h3>
      <div class="form-row"><label>Spese esenti €:</label><input type="number" id="spese-esenti" placeholder="0.00" step="0.01"></div>
      <div class="form-row"><label>Spese di trasferta €:</label><input type="number" id="spese-trasferta" placeholder="0.00" step="0.01"></div>
      <div class="form-row"><label>Altre spese imponibili €:</label><input type="number" id="spese-altre" placeholder="0.00" step="0.01"></div>
      <div class="form-row"><label>Spese generali %:</label><input type="number" value="15" id="spese-generali"><span>art. 2</span></div>
      <button type="button" class="reset" onclick="azzeraSpese()">Azzera Spese</button>
    </div>
  </div>
  
  <div class="total-box">
    Totale Provvisorio: € <input type="text" id="totale-provvisorio" value="0.00" readonly>
  </div>
  
  <div class="action-buttons">
    <button type="button" onclick="aggiornaTotale()">Ricalcola Totale</button>
  </div>
  
  <div class="card" style="border-top-color: var(--primary-color); margin-top: 2rem;">
    <h3>Accessori e Compenso Stimato</h3>
    
    <div class="checkbox-group">
      <label><input type="checkbox" id="iva"> IVA 22%</label>
      <label><input type="checkbox" id="cpa"> CPA 4%</label>
    </div>
    
    <div class="checkbox-group">
      <label><input type="radio" name="ritenuta" value="0" checked> Nessuna ritenuta</label>
      <label><input type="radio" name="ritenuta" value="20"> Ritenuta 20% (residenti)</label>
      <label><input type="radio" name="ritenuta" value="30"> Ritenuta 30% (non residenti)</label>
    </div>
    
    <div class="form-row" style="margin-top: 1rem;">
      <label for="compenso-stimato"><strong>Compenso stimato:</strong></label>
      <input type="text" id="compenso-stimato" value="0.00" readonly style="font-weight: bold; width: 120px;">
    </div>
    
    <div class="action-buttons">
      <button type="button" onclick="calcolaCompensoStimato()">Calcola Compenso</button>
      <button type="button" onclick="location.reload()">Nuovo Calcolo</button>
    </div>
  </div>
  
  <div id="riepilogo" style="margin-top: 2rem;"></div>

  <script>
    /**
     * Dati dei parametri tariffari per ambito giudiziario e scaglione di valore
     * Struttura:
     * {
     *   "Ambito Giudiziario": {
     *     "Scaglione di Valore": [valori per fasi]
     *   }
     * }
     */
    
const tariffari_1fase = {

  "Atto di precetto": {
    "0-5200.00": [142],
    "5200.01-26000.00": [236],
    "26000.01-52000.00": [331],
    "52000.01-260000.00": [425],
    "260000.01-520000.00": [567]
  },
  "Procedimenti di volontaria giurisdizione": {
    "0-5200.00": [425],
    "5200.01-26000.00": [1418],
    "26000.01-52000.00": [2336],
    "52000.01-260000.00": [3329],
    "260000.01-520000.00": [4536]
  },
  "Procedimenti monitori": {
    "0-5200.00": [473],
    "5200.01-26000.00": [567],
    "26000.01-52000.00": [1370],
    "52000.01-260000.00": [2242],
    "260000.01-520000.00": [4394]
  },

 "Iscrizione ipotecaria / Affari tavolari": {
    "0.01-1100.00": [68],
    "1100.01-5200.00": [284],
    "5200.01-26000.00": [425],
    "26000.01-52000.00": [709],
    "52000.01-260000.00": [992],
    "260000.01-520000.00": [1344]
  },
  "Procedimenti per dichiarazione di fallimento": {
    "0.01-1100.00": [168],
    "1100.01-5200.00": [620],
    "5200.01-26000.00": [903],
    "26000.01-52000.00": [1470],
    "52000.01-260000.00": [2095],
    "260000.01-520000.00": [2888]
  },

  "Arbitrato": {
    "0.01-26000.00": [1701],
    "26000.01-52000.00": [4253],
    "52000.01-260000.00": [7439],
    "260000.01-520000.00": [17010]
  }
};

const faseProcessualeUnica = ["Compenso"];


const tariffari_4fasi = {

  "Giudice di pace": {
    "0.01-1100.00": [68, 68, 68, 142],
    "1100.01-5200.00": [236, 252, 352, 425],
    "5200.01-26000.00": [425, 352, 567, 746]
  },
  "Giudizi ordinari e sommari di cognizione innanzi al tribunale": {
    "0.01-1100.00": [131, 131, 200, 200],
    "1100.01-5200.00": [425, 425, 851, 851],
    "5200.01-26000.00": [919, 777, 1680, 1701],
    "26000.01-52000.00": [1701, 1204, 1806, 2905],
    "52000.01-260000.00": [2552, 1628, 5670, 4253],
    "260000.01-520000.00": [3544, 2338, 10411, 6164]
  },
  "Cause di lavoro": {
    "0.01-1100.00": [210, 126, 126, 179],
    "1100.01-5200.00": [888, 425, 567, 746],
    "5200.01-26000.00": [1822, 777, 1172, 1617],
    "26000.01-52000.00": [3245, 1202, 1880, 2930],
    "52000.01-260000.00": [4763, 1701, 2678, 4253],
    "260000.01-520000.00": [6668, 2336, 3623, 6290]
  },
  "Cause di previdenza": {
    "0.01-1100.00": [131, 121, 179, 247],
    "1100.01-5200.00": [425, 425, 851, 919],
    "5200.01-26000.00": [929, 777, 1664, 2021],
    "26000.01-52000.00": [1701, 1204, 2693, 3675],
    "52000.01-260000.00": [2552, 1701, 3827, 4148],
    "260000.01-520000.00": [3544, 2336, 5171, 7865]
  },
  "Procedimenti per convalida locatizia": {
    "0.01-1100.00": [179, 179, 42, 142],
    "1100.01-5200.00": [530, 494, 142, 425],
    "5200.01-26000.00": [919, 709, 210, 746],
    "26000.01-52000.00": [1701, 1061, 352, 1344],
    "52000.01-260000.00": [2478, 1418, 494, 1911],
    "260000.01-520000.00": [3544, 1559, 709, 2835]
  },

  "Procedimenti di istruzione preventiva": {
    "0-5200.00": [210, 284, 352],
    "5200.01-26000.00": [567, 709, 1061],
    "26000.01-52000.00": [992, 788, 1276],
    "52000.01-260000.00": [1134, 992, 1701],
    "260000.01-520000.00": [2126, 1454, 2336]
  },
  "Procedimenti cautelari": {
    "0.01-1100.00": [210, 142, 210, 105],
    "1100.01-5200.00": [567, 352, 851, 389],
    "5200.01-26000.00": [992, 672, 1204, 635],
    "26000.01-52000.00": [1175, 851, 1985, 1202],
    "52000.01-260000.00": [2251, 1202, 2835, 1771],
    "260000.01-520000.00": [3686, 1559, 3969, 2552]
  },
  "Giudizi innanzi alla Corte dei Conti": {
    "0.01-1100.00": [179, 105, 105, 179],
    "1100.01-5200.00": [536, 320, 352, 604],
    "5200.01-26000.00": [919, 494, 567, 1061],
    "26000.01-52000.00": [1775, 709, 919, 1911],
    "52000.01-260000.00": [2478, 1061, 1276, 2762],
    "260000.01-520000.00": [3686, 1418, 1775, 4043]
  },
  "Giudizi innanzi alla Corte di Appello": {
    "0.01-1100.00": [142, 142, 179, 210],
    "1100.01-5200.00": [536, 536, 992, 851],
    "5200.01-26000.00": [1134, 921, 1843, 1911],
    "26000.01-52000.00": [2058, 1418, 3045, 3470],
    "52000.01-260000.00": [2977, 1911, 4326, 5103],
    "260000.01-520000.00": [4389, 2552, 5880, 7298]
  },
  "Giudizi innanzi alla Corte di Cassazione e alle Giurisdizioni Superiori": {
    "0.01-1100.00": [252, 284, null, 142], 
    "1100.01-5200.00": [709, 777, null, 389], 
    "5200.01-26000.00": [1276, 1134, null, 672],
    "26000.01-52000.00": [2336, 1969, null, 1208],
    "52000.01-260000.00": [3402, 2478, null, 1775],
    "260000.01-520000.00": [4961, 3260, null, 2552]
  },

  "Giudizi innanzi alla Corte Costituzionale, alla Corte Europea, alla Corte di Giustizia UE": {
    "0.01-1100.00": [252, 210, 142, 142],
    "1100.01-5200.00": [919, 777, 709, 777],
    "5200.01-26000.00": [1985, 1344, 1344, 1344],
    "26000.01-52000.00": [3686, 2058, 2195, 2478],
    "52000.01-260000.00": [5387, 2905, 3119, 3612],
    "260000.01-520000.00": [7796, 3885, 4253, 5177]
  },
  "Giudizi penali": {
    "Giudice di Pace": [378, 473, 756, 662],
    "Indagini preliminari": [851, 662, 1040, 1229],
    "Indagini difensive": [851, null, 1418, null],
    "Convalida dell'arresto": [378, null, 473, 709],
    "Cautelari personali": [378, 1229, null, 1418],
    "Cautelari reali": [378, 1229, null, 1418],
    "GIP e GUP": [851, 756, 1040, 1418],
    "Tribunale monocratico": [473, 567, 1134, 1418],
    "Tribunale collegiale": [473, 756, 1418, 1418],
    "Corte di Assise": [756, 1418, 2363, 2835],
    "Tribunale di Sorveglianza": [473, 945, 1418, 1418],
    "Magistrato di Sorveglianza": [315, 378, null, 945],
    "Corte di Appello": [473, 945, 1418, 1418],
    "Corte di Assise di Appello": [756, 1985, 2268, 2336],
    "Corte di Cass. e Giur. Sup.": [945, 2646, null, 2741]
  },
  "Procedure esecutive mobiliari": {
    "0.01-1100.00": [126, null, 63, null],
    "1100.01-5200.00": [368, null, 184, null],
    "5200.01-26000.00": [552, null, 305, null],
    "26000.01-52000.00": [861, null, 494, null],
    "52000.01-260000.00": [1166, null, 735, null],
    "260000.01-520000.00": [1533, null, 982, null]
  },
  "Procedure esecutive presso terzi, per consegna e rilascio, in forma specifica": {
    "0.01-1100.00": [null, 110, 236, null],
    "1100.01-5200.00": [null, 331, 567, null],
    "5200.01-26000.00": [null, 552, 851, null],
    "26000.01-52000.00": [null, 861, 1360, null],
    "52000.01-260000.00": [null, 1166, 1927, null],
    "260000.01-520000.00": [null, 1533, 2604, null]
  },
  "Procedure esecutive immobiliari": {
    "0.01-1100.00": [147, null, 76, null],
    "1100.01-5200.00": [452, null, 299, null],
    "5200.01-26000.00": [683, null, 452, null],
    "26000.01-52000.00": [1050, null, 677, null],
    "52000.01-260000.00": [1433, null, 982, null],
    "260000.01-520000.00": [1890, null, 1281, null]
  },

 "Accertamento del passivo nel fallimento e nella liquidazione giudiziale": {
    "0.01-1100.00": [168, 105, 158, 158],
    "1100.01-5200.00": [341, 341, 683, 683],
    "5200.01-26000.00": [735, 620, 1344, 1344],
    "26000.01-52000.00": [1344, 966, 1444, 2326],
    "52000.01-260000.00": [2042, 1302, 4536, 3402],
    "260000.01-520000.00": [2835, 1869, 8327, 4930]
  },
  
 "Procedimento di mediazione e procedura di negoziazione assistita": {
    "0.01-1100.00": [null, 63, 126, 246],
    "1100.01-5200.00": [null, 284, 567, 1106],
    "5200.01-26000.00": [null, 441, 882, 1720],
    "26000.01-52000.00": [null, 536, 1071, 2088],
    "52000.01-260000.00": [null, 1008, 2016, 3931],
    "260000.01-520000.00": [null, 1370, 2741, 5343]
  },

};

// Nomi delle fasi processuali
const fasiProcessuali4 = ["Studio", "Introduzione", "Istruttoria/Trattazione", "Decisione"];





 
const tariffari_6fasi = {

  "Giudizi innanzi al Tribunale Amministrativo Regionale": {
    "0.01-1100.00": [179, 214, 105, 284, 210, 105],
    "1100.01-5200.00": [635, 680, 635, 1061, 567, 284],
    "5200.01-26000.00": [1134, 1103, 992, 1911, 1061, 530],
    "26000.01-52000.00": [2053, 1701, 1628, 3470, 1911, 956],
    "52000.01-260000.00": [3402, 2293, 2268, 5030, 2762, 1381],
    "260000.01-520000.00": [4394, 3062, 3119, 7298, 3969, 1985]
  },
  "Giudizi innanzi al Consiglio di Stato": {
    "0.01-1100.00": [179, 126, 105, 284, 210, 105],
    "1100.01-5200.00": [635, 428, 357, 1061, 635, 318],
    "5200.01-26000.00": [1276, 851, 709, 1911, 1061, 530],
    "26000.01-52000.00": [2268, 1273, 1061, 3470, 1890, 945],
    "52000.01-260000.00": [3402, 1871, 1559, 5030, 2410, 1205],
    "260000.01-520000.00": [4961, 2552, 2126, 7298, 4111, 2056]
  },
  "Giudizi innanzi alla Commissione Tributaria Provinciale": {
    "0.01-1100.00": [179, 105, 89, 179, 142],
    "1100.01-5200.00": [567, 357, 284, 919, 425],
    "5200.01-26000.00": [992, 567, 494, 1418, 709],
    "26000.01-52000.00": [1769, 851, 992, 2195, 1344],
    "52000.01-260000.00": [2552, 1202, 1418, 4169, 1911],
    "260000.01-520000.00": [3686, 1559, 2053, 4321, 2762]
  },
  "Giudizi innanzi alla Commissione Tributaria Regionale": {
    "0.01-1100.00": [179, 105, 105, 179, 142, null],
    "1100.01-5200.00": [635, 425, 425, 919, 494, null],
    "5200.01-26000.00": [1134, 635, 777, 1418, 851, null],
    "26000.01-52000.00": [2053, 1061, 1418, 2478, 1559, null],
    "52000.01-260000.00": [3045, 1418, 2053, 3260, 2268, null],
    "260000.01-520000.00": [4394, 1911, 3045, 4536, 3329, null]
  },
};

// Nomi delle fasi processuali
const fasiProcessuali6 = ["Studio", "Introduzione", "Istruttoria/Trattazione", "Decisione", "Decisione", "Cautelare collegiale", "Cautelare monocratica"];



const tariffari_stragiudiziale = {
  "Prestazioni di assistenza stragiudiziale": {
    "0.01-1100.00": [284],
    "1100.01-5200.00": [1276],
    "5200.01-26000.00": [1985],
    "26000.01-52000.00": [2410],
    "52000.01-260000.00": [4536],
    "260000.01-520000.00": [6164],
    "520000.01-2000000.00": ["3.00%"],
    "2000000.01-4000000.00": ["2.75%"],
    "4000000.01-6000000.00": ["2.50%"],
    "6000000.01-8000000.00": ["2.25%"],
    "8000000.01-10000000.00": ["2.00%"],
    "10000000.01-12000000.00": ["1.75%"],
    "12000000.01-14000000.00": ["1.50%"],
    "14000000.01-16000000.00": ["1.25%"],
    "16000000.01-18000000.00": ["1.00%"],
    "18000000.01-20000000.00": ["0.75%"],
    "20000000.01-22000000.00": ["0.50%"],
    "22000000.01": ["0.25%"]
  }
};





const datasets = {tariffari_1fase: tariffari_1fase,  tariffari_4fasi: tariffari_4fasi,  tariffari_6fasi: tariffari_6fasi, stragiudiziale: tariffari_stragiudiziale};
const fasiPerTipo = {
  stragiudiziale: ["Compenso"],
  tariffari_1fase: ["Compenso"],
  tariffari_4fasi: ["Studio","Introduzione","Istruttoria/Trattazione","Decisione"],
  tariffari_6fasi: ["Studio","Introduzione","Istruttoria/Trattazione","Decisione","Cautelare collegiale","Cautelare monocratica"]
};

    
    // Helper: parse numbers with comma/point
function parseNum(v) {
  if (typeof v === 'number') return v;
  if (!v) return 0;
  const s = String(v).trim();
  if (/^[0-9.]*,[0-9]+$/.test(s)) {
    return parseFloat(s.replace('.', '').replace(',', '.')) || 0;
  }
  return parseFloat(s) || 0;
}
function fmt2(n){ return (Number(n)||0).toFixed(2); }

// Elementi DOM principali
    const ambitoSelect = document.getElementById("ambito");
    const scaglioneSelect = document.getElementById("scaglione");
    const fasiContainer = document.getElementById("fasi");
    const totaleInput = document.getElementById("totale");
    const totaleProvvisorioInput = document.getElementById("totale-provvisorio");
    const riepilogoContainer = document.getElementById("riepilogo");





function getTariffario() {
  const tipo = document.getElementById('tipoTariffario').value;
  return datasets[tipo] || {};
}
// Correggi la definizione di getFasiLabels
function getFasiLabels() {
  const tipo = document.getElementById('tipoTariffario').value;
  return fasiPerTipo[tipo];
}


    /**
     * Inizializza l'applicazione
     */
    function init() {
      caricaAmbiti();
      setupEventListeners();
    }

    /**
     * Carica gli ambiti giudiziari nel select
     */
    function caricaAmbiti() {
      ambitoSelect.innerHTML = '<option value="">-- Seleziona ambito --</option>' + 
        Object.keys(getTariffario()).map(a => `<option value="${a}">${a}</option>`).join("");
    }

    /**
     * Configura gli event listeners
     */
    function setupEventListeners() {
      document.getElementById('tipoTariffario').addEventListener('change', () => {
        const tipo = document.getElementById('tipoTariffario').value;
        const ambitoGroup = document.getElementById('ambitoGroup');
        
        if (tipo === 'stragiudiziale') {
          // Nascondi solo l'ambito giudiziario per stragiudiziale
          ambitoGroup.style.display = 'none';
          
          // Carica direttamente gli scaglioni per stragiudiziale
          scaglioneSelect.innerHTML = '<option value="">-- Seleziona scaglione --</option>' + 
            Object.keys(tariffari_stragiudiziale["Prestazioni di assistenza stragiudiziale"])
              .map(s => `<option value="${s}">${s}</option>`).join("");
        } else {
          // Mostra l'ambito giudiziario per gli altri tipi
          ambitoGroup.style.display = 'block';
          ambitoSelect.value = '';
          scaglioneSelect.innerHTML = '<option value="">-- seleziona --</option>';
          caricaAmbiti();
        }
        
        // Gestione visibilità sezioni aumenti/riduzioni
        document.querySelectorAll('.card').forEach(card => {
          if (tipo === 'stragiudiziale') {
            if (card.querySelector('h3').textContent.includes('Aumenti') || 
                card.querySelector('h3').textContent.includes('Riduzioni')) {
              card.style.display = 'none';
            } else {
              card.style.display = 'block';
            }
          } else {
            card.style.display = 'block';
          }
        });
        
        fasiContainer.innerHTML = '';
        riepilogoContainer.innerHTML = '';
      });
      
      // Resto degli event listener rimasto invariato
      ambitoSelect.addEventListener("change", caricaScaglioni);
      scaglioneSelect.addEventListener("change", caricaFasi);
      fasiContainer.addEventListener("input", aggiornaTotale);
      fasiContainer.addEventListener("change", aggiornaTotale);
      
      document.querySelectorAll('.card input').forEach(input => {
        input.addEventListener('change', aggiornaTotale);
      });
    }
    /**
     * Carica gli scaglioni di valore in base all'ambito selezionato
     */
    function caricaScaglioni() {
      const ambito = ambitoSelect.value;
      const scaglioni = getTariffario()[ambito] || {};
      
      scaglioneSelect.innerHTML = '<option value="">-- Seleziona scaglione --</option>' + 
        Object.keys(scaglioni).map(s => `<option value="${s}">${s}</option>`).join("");
      
      if (scaglioneSelect.options.length > 1) {
        scaglioneSelect.selectedIndex = 1;
        caricaFasi();
      } else {
        fasiContainer.innerHTML = '';
        resetTotali();
      }
    }

    /**
     * Carica le fasi processuali in base all'ambito e scaglione selezionati
     */
    function caricaFasi() {
      const tipoTariffario = document.getElementById('tipoTariffario').value;
      const scaglione = scaglioneSelect.value;
      
      if (!scaglione) {
        fasiContainer.innerHTML = '';
        resetTotali();
        return;
      }
      
      fasiContainer.innerHTML = '';

      // Caso stragiudiziale
      if (tipoTariffario === 'stragiudiziale') {
        const valori = tariffari_stragiudiziale["Prestazioni di assistenza stragiudiziale"][scaglione] || [];
        
        // Lista degli scaglioni percentuali
        const scaglioniPercentuali = [
          "520000.01-2000000.00",
          "2000000.01-4000000.00",
          "4000000.01-6000000.00",
          "6000000.01-8000000.00",
          "8000000.01-10000000.00",
          "10000000.01-12000000.00",
          "12000000.01-14000000.00",
          "14000000.01-16000000.00",
          "16000000.01-18000000.00",
          "18000000.01-20000000.00",
          "20000000.01-22000000.00",
          "22000000.01"
        ];
        
        const isPercentuale = scaglioniPercentuali.includes(scaglione);
        
        const row = document.createElement("tr");
        if (isPercentuale) {
          // Per scaglioni con percentuale
          const percentuale = valori[0].replace('%', '');
          row.innerHTML = `
            <td><input type="checkbox" class="chk" checked></td>
            <td>Prestazioni di assistenza stragiudiziale</td>
            <td><input type="number" class="neg" value="0" min="0" max="100"></td>
            <td>
              <input type="text" class="valore-pratica" placeholder="Inserisci valore pratica" style="width: 120px;">
              <span>${percentuale}%</span>
            </td>
            <td><input type="number" class="pos" value="0" min="0"></td>
            <td><input type="text" class="parziale" value="0.00" readonly></td>
          `;
        } else {
          // Per scaglioni con valore fisso
          row.innerHTML = `
            <td><input type="checkbox" class="chk" checked></td>
            <td>Prestazioni di assistenza stragiudiziale</td>
            <td><input type="number" class="neg" value="0" min="0" max="100"></td>
            <td><input type="text" class="medio" value="${valori[0]}" readonly></td>
            <td><input type="number" class="pos" value="0" min="0"></td>
            <td><input type="text" class="parziale" value="0.00" readonly></td>
          `;
        }
        fasiContainer.appendChild(row);
        
        // Aggiungi listener per aggiornare il totale quando cambia il valore pratica
        const valorePraticaInput = row.querySelector(".valore-pratica");
        if (valorePraticaInput) {
          valorePraticaInput.addEventListener('input', aggiornaTotale);
        }
      } else {
        // Caso normale (giudiziale)
        const ambito = ambitoSelect.value;
        const valori = getTariffario()[ambito][scaglione] || [];
        
        getFasiLabels().forEach((fase, index) => {
          const valore = valori[index] !== null && valori[index] !== undefined ? valori[index] : 0;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" class="chk" checked></td>
            <td>${fase}</td>
            <td><input type="number" class="neg" value="0" min="0" max="100"></td>
            <td><input type="text" class="medio" value="${valore}" readonly></td>
            <td><input type="number" class="pos" value="0" min="0"></td>
            <td><input type="text" class="parziale" value="0.00" readonly></td>
          `;
          fasiContainer.appendChild(row);
        });
      }

      aggiornaTotale();
    }
    /**
     * Calcola e aggiorna i totali
     */
    function aggiornaTotale() {
      let totale = calcolaTotaleFasi();
      totaleInput.value = totale.toFixed(2);
      
      const totaleProvvisorio = calcolaTotaleProvvisorio(totale);
      totaleProvvisorioInput.value = totaleProvvisorio.toFixed(2);
    }

    /**
     * Calcola il totale delle fasi selezionate
     * @returns {number} Totale compenso tabellare
     */
    function calcolaTotaleFasi() {
      let totale = 0;
      const rows = fasiContainer.querySelectorAll("tr");
      const tipoTariffario = document.getElementById('tipoTariffario').value;
      
      rows.forEach(row => {
        const chk = row.querySelector(".chk");
        const medio = parseFloat(row.querySelector(".medio")?.value) || 0;
        const neg = parseFloat(row.querySelector(".neg").value) || 0;
        const pos = parseFloat(row.querySelector(".pos").value) || 0;
        const parzialeInput = row.querySelector(".parziale");
        const valorePraticaInput = row.querySelector(".valore-pratica");
        
        if (chk.checked) {
          let compenso = 0;
          
          if (tipoTariffario === 'stragiudiziale' && valorePraticaInput) {
            // Calcolo per scaglioni percentuali stragiudiziali
            const valorePratica = parseFloat(valorePraticaInput.value) || 0;
            const percentualeText = row.querySelector("td:nth-child(4) span")?.textContent || "0%";
            const percentuale = parseFloat(percentualeText.replace('%', '')) || 0;
            compenso = valorePratica * (percentuale / 100);
          } else {
            // Calcolo normale o stragiudiziale con valore fisso
            compenso = medio;
          }
          
          if (neg > 0) compenso *= (1 - neg / 100);
          if (pos > 0) compenso *= (1 + pos / 100);
          compenso = parseFloat(compenso.toFixed(2));
          parzialeInput.value = compenso.toFixed(2);
          totale += compenso;
        } else {
          parzialeInput.value = "0.00";
        }
      });
      
      return totale;
    }

    /**
     * Calcola il totale provvisorio applicando aumenti, riduzioni e spese
     * @param {number} totale - Totale compenso tabellare
     * @returns {number} Totale provvisorio
     */
    
    function calcolaTotaleProvvisorio(totale) {
      const tipoTariffario = document.getElementById('tipoTariffario').value;

      // Spese
      const speseEsenti = parseNum(document.getElementById("spese-esenti").value) || 0;
      const speseTrasferta = parseNum(document.getElementById("spese-trasferta").value) || 0;
      const speseAltre = parseNum(document.getElementById("spese-altre").value) || 0;
      const speseGeneraliPerc = parseNum(document.getElementById("spese-generali").value) || 0;

      let totaleAumenti = 0;
      let totaleRiduzioni = 0;

      if (tipoTariffario !== 'stragiudiziale') {
        const aumenti = {
          parti: parseNum(document.getElementById("aumento-parti").value) || 0,
          conciliazione: parseNum(document.getElementById("aumento-conciliazione").value) || 0,
          class: parseNum(document.getElementById("aumento-class").value) || 0,
          fondatezza: parseNum(document.getElementById("aumento-fondatezza").value) || 0,
          valutazione: parseNum(document.getElementById("aumento-valutazione").value) || 0,
          pct: parseNum(document.getElementById("aumento-pct").value) || 0
        };
        totaleAumenti = totale * (
          aumenti.parti/100 + aumenti.conciliazione/100 + aumenti.class/100 +
          aumenti.fondatezza/100 + aumenti.valutazione/100 + aumenti.pct/100
        );

        const riduzioni = {
          assenza: parseNum(document.getElementById("riduzione-assenza").value) || 0,
          condotte: parseNum(document.getElementById("riduzione-condotte").value) || 0,
          resp: parseNum(document.getElementById("riduzione-resp").value) || 0,
          rito: parseNum(document.getElementById("riduzione-rito").value) || 0,
          patrocinio: parseNum(document.getElementById("riduzione-patrocinio").value) || 0,
          praticante: parseNum(document.getElementById("riduzione-praticante").value) || 0
        };
        totaleRiduzioni = totale * (
          riduzioni.assenza/100 + riduzioni.condotte/100 + riduzioni.resp/100 +
          riduzioni.rito/100 + riduzioni.patrocinio/100 + riduzioni.praticante/100
        );
      }

      const compensoBase = totale + totaleAumenti - totaleRiduzioni + speseEsenti + speseTrasferta + speseAltre;
      const speseGenerali = compensoBase * (speseGeneraliPerc / 100);

      return compensoBase + speseGenerali;
    }

function calcolaCompensoStimato() {
        const totale = parseNum(document.getElementById("totale").value) || 0;
        const tipoTariffario = document.getElementById('tipoTariffario').value;

        const speseEsenti = parseNum(document.getElementById("spese-esenti")?.value) || 0;
        const speseTrasferta = parseNum(document.getElementById("spese-trasferta")?.value) || 0;
        const speseAltre = parseNum(document.getElementById("spese-altre")?.value) || 0;
        const speseGeneraliPerc = parseNum(document.getElementById("spese-generali")?.value) || 0;

        let riepilogo = `
            <div class="card" style="margin-top: 2rem;">
                <h3>PROSPETTO FINALE PREVENTIVO</h3>
                <div class="action-buttons" style="margin-bottom: 1rem;">
                    <button type="button" onclick="salvaJsonAuto()">Salva JSON</button>
                    <button type="button" onclick="salvaXmlAuto()">Salva XML in Download/Scaricati</button>
                    <button type="button" onclick="salvaPdf()">Genera PDF</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Voce</th>
                                <th>Importo (€)</th>
                            </tr>
                        </thead>
                        <tbody>`;

        riepilogo += `<tr><td>Compenso tabellare</td><td>${fmt2(totale)}</td></tr>`;

        let totaleAumenti = 0;
        let totaleRiduzioni = 0;

        if (tipoTariffario !== 'stragiudiziale') {
            const aumentiIds = ["aumento-parti", "aumento-conciliazione", "aumento-class", 
                               "aumento-fondatezza", "aumento-valutazione", "aumento-pct"];
            aumentiIds.forEach(id => {
                const percentuale = parseNum(document.getElementById(id)?.value) || 0;
                if (percentuale !== 0) {
                    const valoreAumento = totale * (percentuale / 100);
                    totaleAumenti += valoreAumento;
                    const label = document.querySelector(`label[for='${id}']`)?.textContent?.trim() || id;
                    riepilogo += `<tr><td>${label} (${percentuale}%)</td><td>${fmt2(valoreAumento)}</td></tr>`;
                }
            });

            const riduzioneIds = ["riduzione-assenza", "riduzione-condotte", "riduzione-resp", 
                                "riduzione-rito", "riduzione-patrocinio", "riduzione-praticante"];
            riduzioneIds.forEach(id => {
                const percentuale = parseNum(document.getElementById(id)?.value) || 0;
                if (percentuale !== 0) {
                    const valoreRiduzione = totale * (percentuale / 100);
                    totaleRiduzioni += valoreRiduzione;
                    const label = document.querySelector(`label[for='${id}']`)?.textContent?.trim() || id;
                    riepilogo += `<tr><td>${label} (${percentuale}%)</td><td>-${fmt2(valoreRiduzione)}</td></tr>`;
                }
            });
        }

        if (speseEsenti) riepilogo += `<tr><td>Spese esenti</td><td>${fmt2(speseEsenti)}</td></tr>`;
        if (speseTrasferta) riepilogo += `<tr><td>Spese di trasferta</td><td>${fmt2(speseTrasferta)}</td></tr>`;
        if (speseAltre) riepilogo += `<tr><td>Altre spese imponibili</td><td>${fmt2(speseAltre)}</td></tr>`;

        let compensoBase = totale + totaleAumenti - totaleRiduzioni + speseEsenti + speseTrasferta + speseAltre;

        const speseGenerali = compensoBase * (speseGeneraliPerc / 100);
        if (speseGeneraliPerc) {
            riepilogo += `<tr><td>Spese generali (${speseGeneraliPerc}%)</td><td>${fmt2(speseGenerali)}</td></tr>`;
        }

        let cpa = 0;
        if (document.getElementById("cpa").checked) {
            cpa = (compensoBase + speseGenerali) * 0.04;
            riepilogo += `<tr><td>Cassa Avvocati (4%)</td><td>${fmt2(cpa)}</td></tr>`;
        }

        let imponibile = compensoBase + speseGenerali + cpa;
        riepilogo += `<tr><td><strong>Totale Imponibile</strong></td><td><strong>${fmt2(imponibile)}</strong></td></tr>`;

        let iva = 0;
        if (document.getElementById("iva").checked) {
            iva = imponibile * 0.22;
            riepilogo += `<tr><td>IVA (22%)</td><td>${fmt2(iva)}</td></tr>`;
        }

        let totaleLordo = imponibile + iva;
        riepilogo += `<tr><td><strong>Totale lordo</strong></td><td><strong>${fmt2(totaleLordo)}</strong></td></tr>`;

        let ritenuta = document.querySelector("input[name='ritenuta']:checked").value;
        let ritenutaVal = 0;
        if (ritenuta !== "0") {
            let imponibileRitenuta = compensoBase + speseGenerali;
            ritenutaVal = imponibileRitenuta * (parseNum(ritenuta) / 100);
            riepilogo += `<tr><td>Ritenuta d'acconto (${ritenuta}%)</td><td>-${fmt2(ritenutaVal)}</td></tr>`;
        }

        let totaleDocumento = totaleLordo - ritenutaVal;
        document.getElementById("compenso-stimato").value = fmt2(totaleDocumento);

        riepilogo += `<tr style="background-color: var(--light-gray); font-weight: bold;">
                    <td>TOTALE DOCUMENTO</td>
                    <td>${fmt2(totaleDocumento)}</td>
                   </tr>`;
        riepilogo += `</tbody></table></div></div>`;

        document.getElementById("riepilogo").innerHTML = riepilogo;
    }

    // Ottenere tutti i dati necessari
    function salvaJsonAuto() {
      const tipoTariffario = document.getElementById('tipoTariffario').value;
      const ambito = document.getElementById("ambito").value || "Non specificato";
      const scaglione = document.getElementById("scaglione").value || "Non specificato";
      const totaleTabellare = parseFloat(document.getElementById("totale").value) || 0;
      const compensoStimato = parseFloat(document.getElementById("compenso-stimato").value) || 0;
      const ivaChecked = document.getElementById("iva").checked;
      const cpaChecked = document.getElementById("cpa").checked;
      const ritenuta = document.querySelector("input[name='ritenuta']:checked").value;

      // --- Fasi (azzero Aumenti/Riduzioni salvati se stragiudiziale) ---
      const fasiData = [];
      document.querySelectorAll("#fasi tr").forEach((fase, index) => {
        const nomeFase = fase.querySelector("td:nth-child(2)")?.textContent?.trim() || `Fase ${index+1}`;
        const chk = fase.querySelector(".chk");
        const medio = fase.querySelector(".medio")?.value || "0";
        const neg = fase.querySelector(".neg")?.value || "0";
        const pos = fase.querySelector(".pos")?.value || "0";
        const parziale = fase.querySelector(".parziale")?.value || "0.00";

        fasiData.push({
          nome: nomeFase,
          selezionata: !!(chk && chk.checked),
          valoreMedio: parseFloat(medio) || 0,
          riduzionePercentuale: (tipoTariffario === 'stragiudiziale') ? 0 : (parseFloat(neg) || 0),
          aumentoPercentuale:   (tipoTariffario === 'stragiudiziale') ? 0 : (parseFloat(pos) || 0),
          compensoParziale: parseFloat(parziale) || 0
        });
      });

      // --- Prospetto finale ---
      const vociProspetto = [];
      vociProspetto.push({ descrizione: "Compenso tabellare", importo: totaleTabellare });

      // AUMENTI (solo non-stragiudiziale)
      let totaleAumenti = 0;
      if (tipoTariffario !== 'stragiudiziale') {
        const aumentiIds = ["aumento-parti","aumento-conciliazione","aumento-class","aumento-fondatezza","aumento-valutazione","aumento-pct"];
        aumentiIds.forEach(id => {
          const p = parseFloat(document.getElementById(id)?.value) || 0;
          if (p !== 0) {
            const valore = totaleTabellare * (p/100);
            totaleAumenti += valore;
            const label = document.querySelector(`label[for="${id}"]`)?.textContent?.trim() || id;
            vociProspetto.push({ descrizione: `${label} (${p}%)`, importo: valore });
          }
        });
      }

      // RIDUZIONI (solo non-stragiudiziale)
      let totaleRiduzioni = 0;
      if (tipoTariffario !== 'stragiudiziale') {
        const riduzioneIds = ["riduzione-assenza","riduzione-condotte","riduzione-resp","riduzione-rito","riduzione-patrocinio","riduzione-praticante"];
        riduzioneIds.forEach(id => {
          const p = parseFloat(document.getElementById(id)?.value) || 0;
          if (p !== 0) {
            const valore = totaleTabellare * (p/100);
            totaleRiduzioni += valore;
            const label = document.querySelector(`label[for="${id}"]`)?.textContent?.trim() || id;
            vociProspetto.push({ descrizione: `${label} (${p}%)`, importo: -valore });
          }
        });
      }

      // Spese
      const speseEsenti = parseFloat(document.getElementById("spese-esenti")?.value) || 0;
      const speseTrasferta = parseFloat(document.getElementById("spese-trasferta")?.value) || 0;
      const speseAltre = parseFloat(document.getElementById("spese-altre")?.value) || 0;
      if (speseEsenti)   vociProspetto.push({ descrizione: "Spese esenti", importo: speseEsenti });
      if (speseTrasferta) vociProspetto.push({ descrizione: "Spese di trasferta", importo: speseTrasferta });
      if (speseAltre)    vociProspetto.push({ descrizione: "Altre spese imponibili", importo: speseAltre });

      // Spese generali (rispetta % impostata a UI)
      const speseGeneraliPerc = parseFloat(document.getElementById("spese-generali")?.value) || 0;
      const compensoBase = totaleTabellare + totaleAumenti - totaleRiduzioni + speseEsenti + speseTrasferta + speseAltre;
      const speseGenerali = compensoBase * (speseGeneraliPerc/100);
      if (speseGeneraliPerc) {
        vociProspetto.push({ descrizione: `Spese generali (${speseGeneraliPerc}%)`, importo: speseGenerali });
      }

      // CPA
      let cpaVal = 0;
      if (cpaChecked) {
        cpaVal = (compensoBase + speseGenerali) * 0.04;
        vociProspetto.push({ descrizione: "Cassa Avvocati (4%)", importo: cpaVal });
      }

      // IVA
      let ivaVal = 0;
      if (ivaChecked) {
        const imponibileIva = compensoBase + speseGenerali + cpaVal;
        ivaVal = imponibileIva * 0.22;
        vociProspetto.push({ descrizione: "IVA (22%)", importo: ivaVal });
      }

      // Ritenuta (sempre sull’imponibile senza CPA)
      let ritenutaVal = 0;
      if (ritenuta !== "0") {
        const imponibileRitenuta = compensoBase + speseGenerali;
        ritenutaVal = imponibileRitenuta * (parseFloat(ritenuta)/100);
        vociProspetto.push({ descrizione: `Ritenuta d'acconto (${ritenuta}%)`, importo: -ritenutaVal });
      }

      vociProspetto.push({ descrizione: "TOTALE DOCUMENTO", importo: compensoStimato });

      // JSON finale
      const jsonData = {
        metadata: {
          data: new Date().toISOString().split('T')[0],
          ambito, scaglione,
          tipoTariffario,
          ivaApplicata: ivaChecked,
          cpaApplicata: cpaChecked,
          ritenutaApplicata: ritenuta !== "0" ? `${ritenuta}%` : "Nessuna"
        },
        fasi: fasiData,
        compensoTabellare: totaleTabellare,
        prospettoFinale: vociProspetto,
        totaleDocumento: compensoStimato
      };

      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      const nomeFile = `Preventivo_${(ambito || 'Stragiudiziale').replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.json`;
      a.href = URL.createObjectURL(blob);
      a.download = nomeFile;
      a.click();
    }
    /**
     * Salva i dati in formato XML con scelta percorso
     */
    function salvaXmlAuto() {
        // Ottenere tutti i dati necessari
        const ambito = document.getElementById("ambito").value || "Non specificato";
        const scaglione = document.getElementById("scaglione").value || "Non specificato";
        const totaleTabellare = parseNum(document.getElementById("totale").value) || 0;
        const compensoStimato = parseNum(document.getElementById("compenso-stimato").value) || 0;
        const ivaChecked = document.getElementById("iva").checked;
        const cpaChecked = document.getElementById("cpa").checked;
        const ritenuta = document.querySelector("input[name='ritenuta']:checked").value;
        
        // Raccolta dati fasi
        const fasiData = [];
        const fasiElements = document.querySelectorAll("#fasi tr");
        fasiElements.forEach((fase, index) => {
            const nomeFase = fase.querySelector("td:nth-child(2)")?.textContent?.trim() || `Fase ${index+1}`;
            const chk = fase.querySelector(".chk");
            const medio = fase.querySelector(".medio")?.value || "0";
            const neg = fase.querySelector(".neg")?.value || "0";
            const pos = fase.querySelector(".pos")?.value || "0";
            const parziale = fase.querySelector(".parziale")?.value || "0.00";
            
            fasiData.push({
                nome: nomeFase,
                selezionata: chk ? chk.checked : false,
                valoreMedio: medio,
                percentualeNeg: neg,
                percentualePos: pos,
                compensoParziale: parziale
            });
        });
        
        // Raccolta dati per il prospetto finale
        const vociProspetto = [];
        const importiProspetto = [];
        
        // 1. Compenso tabellare
        vociProspetto.push("Compenso tabellare");
        importiProspetto.push(totaleTabellare.toFixed(2));
        
        // 2. Aumenti
        const aumentiIds = ["aumento-parti", "aumento-conciliazione", "aumento-class", 
                           "aumento-fondatezza", "aumento-valutazione", "aumento-pct"];
        let totaleAumenti = 0;
        
        aumentiIds.forEach(id => {
            const percentuale = parseFloat(document.getElementById(id)?.value) || 0;
            if (percentuale !== 0) {
                const valoreAumento = totaleTabellare * (percentuale / 100);
                totaleAumenti += valoreAumento;
                const label = document.querySelector(`label[for="${id}"]`)?.textContent?.trim() || id;
                vociProspetto.push(`${label} (${percentuale}%)`);
                importiProspetto.push(valoreAumento.toFixed(2));
            }
        });
        
        // 3. Riduzioni
        const riduzioneIds = ["riduzione-assenza", "riduzione-condotte", "riduzione-resp", 
                             "riduzione-rito", "riduzione-patrocinio", "riduzione-praticante"];
        let totaleRiduzioni = 0;
        
        riduzioneIds.forEach(id => {
            const percentuale = parseFloat(document.getElementById(id)?.value) || 0;
            if (percentuale !== 0) {
                const valoreRiduzione = totaleTabellare * (percentuale / 100);
                totaleRiduzioni += valoreRiduzione;
                const label = document.querySelector(`label[for="${id}"]`)?.textContent?.trim() || id;
                vociProspetto.push(`${label} (${percentuale}%)`);
                importiProspetto.push(`-${valoreRiduzione.toFixed(2)}`);
            }
        });
        
        // 4. Spese
        const speseEsenti = parseFloat(document.getElementById("spese-esenti")?.value) || 0;
        const speseTrasferta = parseFloat(document.getElementById("spese-trasferta")?.value) || 0;
        const speseAltre = parseFloat(document.getElementById("spese-altre")?.value) || 0;
        
        if (speseEsenti > 0) {
            vociProspetto.push("Spese esenti");
            importiProspetto.push(speseEsenti.toFixed(2));
        }
        if (speseTrasferta > 0) {
            vociProspetto.push("Spese di trasferta");
            importiProspetto.push(speseTrasferta.toFixed(2));
        }
        if (speseAltre > 0) {
            vociProspetto.push("Altre spese imponibili");
            importiProspetto.push(speseAltre.toFixed(2));
        }
        
        // 5. Spese generali (15% del compenso base)
        const compensoBase = totaleTabellare + totaleAumenti - totaleRiduzioni + speseEsenti + speseTrasferta + speseAltre;
        const speseGenerali = compensoBase * 0.15;
        vociProspetto.push("Spese generali (15%)");
        importiProspetto.push(speseGenerali.toFixed(2));
        
        // 6. CPA (4% del compenso base + spese generali)
        let cpaVal = 0;
        if (cpaChecked) {
            cpaVal = (compensoBase + speseGenerali) * 0.04;
            vociProspetto.push("Cassa Avvocati (4%)");
            importiProspetto.push(cpaVal.toFixed(2));
        }
        
        // 7. IVA (22% dell'imponibile)
        let ivaVal = 0;
        if (ivaChecked) {
            const imponibileIva = compensoBase + speseGenerali + cpaVal;
            ivaVal = imponibileIva * 0.22;
            vociProspetto.push("IVA (22%)");
            importiProspetto.push(ivaVal.toFixed(2));
        }
        
        // 8. Ritenuta (applicata a compenso base + spese generali, senza CPA)
        let ritenutaVal = 0;
        if (ritenuta !== "0") {
            const imponibileRitenuta = compensoBase + speseGenerali;
            ritenutaVal = imponibileRitenuta * (parseFloat(ritenuta) / 100);
            vociProspetto.push(`Ritenuta d'acconto (${ritenuta}%)`);
            importiProspetto.push(`-${ritenutaVal.toFixed(2)}`);
        }
        
        // 9. Totale documento
        vociProspetto.push("TOTALE DOCUMENTO");
        importiProspetto.push(compensoStimato.toFixed(2));
        
        // Generazione XML
        let xml = `<?xml version="1.0" encoding="UTF-8"?>
    <Preventivo>
        <Intestazione>
            <Data>${new Date().toISOString().split('T')[0]}</Data>
            <Ambito>${ambito}</Ambito>
            <Scaglione>${scaglione}</Scaglione>
        </Intestazione>
        
        <FasiProcessuali>`;
        
        // Aggiungi dettagli fasi
        fasiData.forEach(fase => {
            xml += `
            <Fase>
                <Nome>${fase.nome}</Nome>
                <Selezionata>${fase.selezionata}</Selezionata>
                <ValoreMedio>${fase.valoreMedio}</ValoreMedio>
                <RiduzionePercentuale>${fase.percentualeNeg}</RiduzionePercentuale>
                <AumentoPercentuale>${fase.percentualePos}</AumentoPercentuale>
                <CompensoParziale>${fase.compensoParziale}</CompensoParziale>
            </Fase>`;
        });
        
        xml += `
        </FasiProcessuali>
        
        <CompensoTabellare>${totaleTabellare.toFixed(2)}</CompensoTabellare>
        
        <ProspettoFinale>`;
        
        // Aggiungi voci e importi del prospetto
        vociProspetto.forEach((voce, index) => {
            xml += `
            <Voce>
                <Descrizione>${voce}</Descrizione>
                <Importo>${importiProspetto[index]}</Importo>
            </Voce>`;
        });
        
        xml += `
        </ProspettoFinale>
    </Preventivo>`;
        
        // Creazione e download del file
        const blob = new Blob([xml], { type: "application/xml" });
        const a = document.createElement("a");
        const nomeFile = `Preventivo_${ambito.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xml`;
        a.href = URL.createObjectURL(blob);
        a.download = nomeFile;
        a.click();
    }
    /**
     * Genera un PDF dal riepilogo
     */
    function salvaPdf() {
      const contenuto = riepilogoContainer.innerHTML;
      const win = window.open("", "", "height=700,width=900");
      win.document.write(`
        <html>
          <head>
            <title>Prospetto Compenso</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              table { width: 100%; border-collapse: collapse; margin: 15px 0; }
              th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
              th { background-color: #2c3e50; color: white; }
              .total-row { font-weight: bold; background-color: #f2f2f2; }
</style>
          </head>
          <body>
            ${contenuto}
          </body>
        </html>
      `);
      win.document.close();
      win.print();
    }

    // Funzioni di reset
    function azzeraAumenti() {
      document.getElementById("aumento-parti").value = 0;
      document.getElementById("aumento-conciliazione").value = 0;
      document.getElementById("aumento-class").value = 0;
      document.getElementById("aumento-fondatezza").value = 0;
      document.getElementById("aumento-valutazione").value = 0;
      document.getElementById("aumento-pct").value = 0;
      aggiornaTotale();
    }

    function azzeraRiduzioni() {
      document.getElementById("riduzione-assenza").value = 0;
      document.getElementById("riduzione-condotte").value = 0;
      document.getElementById("riduzione-resp").value = 0;
      document.getElementById("riduzione-rito").value = 0;
      document.getElementById("riduzione-patrocinio").value = 0;
      document.getElementById("riduzione-praticante").value = 0;
      aggiornaTotale();
    }

    function azzeraSpese() {
      document.getElementById("spese-esenti").value = "";
      document.getElementById("spese-trasferta").value = "";
      document.getElementById("spese-altre").value = "";
      document.getElementById("spese-generali").value = 15;
      aggiornaTotale();
    }

    function resetTotali() {
      totaleInput.value = "0.00";
      totaleProvvisorioInput.value = "0.00";
      document.getElementById("compenso-stimato").value = "0.00";
      riepilogoContainer.innerHTML = "";
    }

    // Inizializza l'applicazione
    init();
  </script>
</body>
</html>
